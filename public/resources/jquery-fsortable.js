$.widget("ntx.fsortable",$.ui.sortable,{options:{emptyClass:"fsortable-empty",existingSortable:!1},_refresh:function(){var e=$("."+this.options.emptyClass,this.element),t=$(this.options.items,this.element).not(e);this._occupied=t.length,this._capacity=e.length,this._size=this._occupied+this._capacity,this._capacity?this.element.removeClass("full"):this.element.addClass("full")},_getFreeSpot:function(e){var t;return e&&e.placeholder[0]?(t=e.placeholder.nextAll("."+this.options.emptyClass+":first")).length||(t=e.placeholder.prevAll("."+this.options.emptyClass+":first")):t=$("."+this.options.emptyClass+":last",this.element),t.length?t:null},_removeFreeSpot:function(e){var t=e||this;t._spot.remove(),t._spot=null,t.element.sortable("refresh"),t._capacity--,t._occupied++,0===t._capacity&&t.element.addClass("full")},_create:function(){var i=this;this.element.addClass("fsortable"),this.options.existingSortable?(this.options.cancel=this.element.sortable("option","cancel"),this.options.cancel+=", ."+this.options.emptyClass,this.element.sortable("option",this.options)):(this.options.cancel+=", ."+this.options.emptyClass,this.element.sortable(this.options)),this._refresh(),this._outside=!1,this._connected=!1,this.element.on("sortactivate",function(e,t){t.sender&&t.sender[0]===this||(i._outside=!0)}),this.element.on("sortdeactivate",function(){i._outside=!1,i._spot&&(i._connected?(i._spot.remove(),i._capacity--,i._occupied++):i._spot.show(),i._spot=null),i._connected=!1}),this.element.on("sortover",function(e,t){i._spot||!0===i._outside&&(i._spot=i._getFreeSpot(t),$(this).one("sortchange.fs",function(){i._spot.hide()}))}),this.element.on("sortreceive",function(){i._spot&&i._removeFreeSpot()}),this.element.on("sortout",function(e,t){$(this).off("sortchange.fs"),i.previous=t.placeholder.next(),i.previous.length||(i.previous=null)}),$(document).on("sortover",".ui-sortable",function(e,t){if(this!==i.element[0]&&t.sender&&t.sender[0]===i.element[0]){var s=t.sender.data(i.widgetFullName),o=$("<div></div>").addClass(i.options.emptyClass);s.previous?o.insertBefore(s.previous):o.appendTo(s.element),t.sender.sortable("refresh"),s._connected||(s._capacity++,s._occupied--),s._outside=!0,s._connected=!0,s._spot&&(s._spot.remove(),s._spot=null),s.element.removeClass("full")}})},_destroy:function(){this.element.removeClass("fsortable full"),this.options.existingSortable||this.element.sortable("destroy")},refresh:function(){this._refresh(),this.element.sortable("refresh")},size:function(){return this._size},capacity:function(){return this._capacity},occupied:function(){return this._occupied}});
